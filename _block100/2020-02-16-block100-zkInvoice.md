---
layout: post
title:  "设想：区块链发票协议"
author: jane
image: block100/block100images/zkInvoice-01.png
categories: [ Jekyll, tutorial ]
tags: 
description: Bucharest’s  its consolidation as the national capital of Romania late in the 19th century. First mentioned as the “Citadel of București” in 1459, it became the residence of the famous Wallachian prince Vlad III the Impaler. # Add post description (optional)
---
场景类别：金融科技

腾讯等公司在深圳协助建立区块链电子发票系统，目前已经开票超过1000万张以上，它所采用的底层链是腾讯的TrustSQL联盟链<sup>1,2,3</sup>。

那么，是否可以采用公链技术来开发一个发票协议呢？如下是一个设想。

## 发票场景分析

腾讯协助建设的深圳发票系统，强调“业务链上流转：优化领票、开票、报销和报税全流程”。

以个人在餐厅消费，取得发票，回公司报销这个场景为例（案例中所说的纳税人为“消费者个人”）：

> 如图所示，区块链电子发票业务流程包括领票、开票、流转、验收和入账等，大致分为以下四个步骤。
> 
> （1）税务机关在税务链上写入开票规则，将开票限制性条件上链、实时核准和管控开票；
> 
> （2）开票企业在链上申领发票，并写入交易订单信息和链上身份标识；
> 
> （3）纳税人在链上认领发票，井更新链上纳税人身份标识；
> 
> （4）收票企业验收发票，锁定链上发票状态，审核入账，更新链上发票状态，最后支付报销款。

![腾讯区块链电子发票业务流程示意图](/block100/block100images/tencent-fapiao.png)

接下来，我们将该流程在区块链中表示。

我们可以认为，发票是不可替换通证（No fungible Token），其规格可以采用以太坊ERC721标准。一张发票包括如下信息：

- 开票单位
- 受票方（即发票抬头）
- 发票信息（商品信息，金额，日期等）

![发票流程](/block100/block100images/zkInvoice-01.png)

那么，在税务机关的监管下，一张发票开出到报销完成的流转流程如下，这里仅考虑发票的流动：

> 1. 个人在商家付款消费，提供发票抬头信息、要求开票，商家的开票机生成有着相关信息的“一张发票”；
> 
> 2. 发票转移进入个人的电子票夹，“一张发票”的状态发生一次转换，所有者从商家变为个人；
> 
> 3. 个人在公司进行发票报销，“一张发票”的状态再次发生转换，所有者从个人变为”受票单位日常库“；
> 
> 4. 财务验收发票、付款、审核入账，此时发票的状态要再次发生转换，我们这里设定的转换方式是，所有者从“受票单位日常库”变为“受票单位存档库”。

如果商家与企业形成直接合作、自动报销，那么，这个流程还可以进一步简化，发票直接从商家转给企业。

### 问题讨论

从业务流程上，这样的逻辑是可行的，用区块链技术有了发票的开票、报销、存档等流程，利用了区块链上表示的通证的几个特性：

- 唯一性；
- 独立可验证；
- 自带状态。

但在实践中，这样的做法有很大的问题：

- 区块链性能问题

无论是公链还是联盟链，以一条链支撑大量发票的开具、流转，都会遇到性能问题，公链尤其如此。

即便采用联盟链系统，当发票系统需要进行跨地区运作时，也必定需要分成多个链，那么接下来也会遇到多个系统之间交互的性能问题。

对于性能问题我们可以乐观看待，随着技术的演进，相关的问题会逐渐解决，就像互联网技术演进带来的网络性能进步一样。

- 商业隐私问题

上述做法更大的问题是商业隐私问题。

商家与个人的开票信息公开在链上，是不可行的，商家与个人均不愿意向其他人透露相关信息。实际上，商家、个人、企业均希望有**绝对的商业隐私保护**措施：

商家、个人、企业的发票关系（交易关系）保密；
发票的详细信息保密。

仅有如下特殊情形：
税务机关进行税务核查，可以查阅相关信息；
企业聘请的会计师审计时获得授权查看原始信息。

实际上，采用联盟链并不能解决此问题。采用联盟链，可以确保外部无人能够获知相关信息，但如果内部有坏人怎么办？在联盟链内采用多重的权限控制可以部分解决这个问题，也可以采用如平安壹帐链所提出的字段级加密<sup>4</sup>。

是否有更优雅的解决方案，在原理上实现“**绝对的商业隐私保护**”？

## 一个建议的解决方案

结合近期的zkRollup与之前的混币技术，这里设计一个第二层协议（Layer 2 Protocol，L2，这里称”发票链“），用zkRollup来提升性能，用混币来保护商业隐私。

![零知识证明方案](/block100/block100images/zkInvoice-02.png)

- 开发一个zkRollup，即建立一条侧链，用CALLDATA将零知识证明上链。因此，在底层链上，其他人无法获知交易信息。此侧链网络由多个节点参与方运维。

- 发票链提供基于零知识证明的发票验真，其他人仅可在自己知道发票信息的情况下，确认该发票的确为真。

- 为使用发票链，用户需要在此发票链（L2）注册。因此，在底层链上， 用户有一对地址/私钥组合，在发票链上，用户获得新的一对地址/私钥组合。
 
只有持有发票链的私钥，一个人才可查看发票信息，但这时其他人可以获知交易关系，即商家开票给某人、某人将发票到公司报销等关系）。

- 为了隐藏交易关系，从商家到个人、从个人到公司这些转移环节，加入混币（混合）逻辑，通过混合，来隐藏交易关系。同时，我们注意到，发票信息中仅有”开票单位-受票人“这一层关系，因此做了两轮混合之后，交易关系可以接近完美隐藏。此时，仅持有私钥，才可以查看发票信息。

- 商家（开票单位）、受票人（报销企业），还可以进行多层次的权限管理，采用零知识证明等技术，仅有最高级别权限才可以查看某一发票的信息，而常规会计权限可以进行汇总结算。

由此，通过建立运用零知识证明、zkRollup、混币等技术的第二层协议网络，我们实现了商业实践中可用的发票系统。

此发票系统提供SDK、API接口，则商家、企业、技术服务商（财务软件、支付服务、即时通讯等）、商业服务商（如审计）可以接入，形成丰富的应用生态。

参考资料：
1. 区块链电子发票与增值税电子发票的区别, 2018.08.14,https://cloud.tencent.com/developer/news/298696
2. 腾讯区块链电子发票，区块链产业应用100例（火币研究院），2019.12 
3. 腾讯强攻区块链电子发票，界面新闻，2019.08.19, https://www.jiemian.com/article/3417807.html 
4. https://baas.yizhangtong.com/


### 附录：腾讯云区块链TBaaS

腾讯云区块链提供了三种区块链引擎：

- Hyperledger Fabric 增强版
- FISCO BCOS
- Tencent TrustSQL

它的应用系统对接如下图：

![应用系统对接](/block100/block100images/Tencent-TBaas.png)

也可以采用Hyperledger的SDK，见[TBaaS文档](https://cloud.tencent.com/document/product/663/30536)。

 对比而言，亚马逊AWS的区块链服务（[Amazon Managed Blockchain](https://aws.amazon.com/cn/managed-blockchain/)）提供了两种区块链引擎：
 
 - Hyperledger Fabric
 - Ethereum
 